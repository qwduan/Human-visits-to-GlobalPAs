library(sf); library(dplyr); library(countrycode); library(ggplot2)
library(tidyr); library(dplyr); library(readr); library(terra)
library(sp); library(rgdal); library(sf); library(purrr)


folder <- "xxx/output/visit/covar_resample"

hf <- read_csv(file.path(folder, "hf.csv")) %>%
  dplyr::select(fishnetid, MEAN) %>%
  rename(hf = MEAN) %>%
  mutate(hf = hf * 0.01)

ele <- read_csv(file.path(folder, "ele.csv")) %>%
  dplyr::select(fishnetid, MEAN) %>%
  rename(elevation = MEAN)


slope <- read_csv(file.path(folder, "slope.csv")) %>%
  dplyr::select(fishnetid, MEAN) %>%
  rename(slope = MEAN)


intialpop <- read_csv(file.path(folder, "intialpop.csv")) %>%
  dplyr::select(fishnetid, RASTERVALU) %>%
  rename(intialpop = RASTERVALU) %>%
  replace_na(list(intialpop = 0))


build <- read_csv(file.path(folder, "building.csv")) %>%
  dplyr::select(fishnetid, SUM) %>%
  rename(building = SUM)


access <- read_csv(file.path(folder, "access.csv")) %>%
  dplyr::select(fishnetid, MEAN) %>%
  rename(access = MEAN)


ndvi <- read_csv(file.path(folder, "ndvi.csv")) %>%
  dplyr::select(fishnetid, RASTERVALU) %>%
  rename(ndvi = RASTERVALU) %>%
  replace_na(list(ndvi = 0))


landuse <- read_csv(file.path(folder, "landuse.csv")) %>%
  dplyr::select(fishnetid, MAJORITY) %>%
  rename(landuse = MAJORITY)%>%
  mutate(landuse = as.factor(landuse))


road_files <- paste0(
  "xxx/output/visit/covar_resample/road",
  1:7,
  ".csv"
)

road_all <- road_files %>%
  map_df(~ read_csv(.x) %>% dplyr::select(fishnetid, SUM_length))
road_all <- road_all %>%
  group_by(fishnetid)%>%
  summarise(road_length = sum(SUM_length, na.rm=TRUE))%>%
  ungroup()




id <- read_csv(file.path(folder, "fishenet_info.csv")) %>%
  dplyr::select(fishnetid,fishnet_area) 


iso <- read_csv(file.path(folder, "iso.csv"))
iso$iso3 <- countrycode(iso$ISO, origin = "iso2c", destination = "iso3c")
iso$iso3[iso$COUNTRY == "Namibia"] <- "NAM"
iso <- iso %>% dplyr::select(fishnetid, iso3) 



match <- hf %>% left_join(id, by = c('fishnetid')) %>%
  left_join(iso, by = 'fishnetid')%>%
  left_join(slope, by = 'fishnetid')%>%
  left_join(ele, by = 'fishnetid')%>%
  left_join(intialpop, by = 'fishnetid')%>%
  left_join(build, by = 'fishnetid')%>%
  left_join(road_all, by = 'fishnetid')%>%
  left_join(landuse, by = 'fishnetid') %>%
  left_join(access, by = 'fishnetid') %>%
  left_join(ndvi, by = 'fishnetid')

match$road_length[is.na(match$road_length)] <- 0



match$road_den <- match$road_length / match$fishnet_area
match$intial_pop_density <- match$intialpop / match$fishnet_area
match$build_den <- match$building / match$fishnet_area
write.csv(match, 'xxx/output/visit/covar_resample/match_var.csv')


fishnet_pa <-  read_csv(file.path(folder, "fishnet_pa.csv"))

fishnet_main_pa <- fishnet_pa %>%
  group_by(fishnetid) %>%
  slice_max(overlap_area, n = 1, with_ties = FALSE) %>% 
  dplyr::select(fishnetid, pa_id, MIN_IUCN_rank, FIRST_ISO3, pa_area) %>%
  ungroup()



match <- match %>% filter(!is.na(access))
match_up <- match %>% left_join(fishnet_main_pa, by = 'fishnetid')



match_up <- match_up %>%
  mutate(
    iso3 = if_else(!is.na(FIRST_ISO3) & iso3 != FIRST_ISO3, FIRST_ISO3, iso3)
  )

country_list <- read_csv('xxx/output/visit/matching/intial_pop.csv') %>%
  dplyr::select(country)%>%
  distinct()
country_list$iso3 <- countrycode(country_list$country, origin = "country.name", destination = "iso3c")

match_up <- match_up %>%
  filter(iso3 %in% country_list$iso3)



###############################strict
treat <-  read_csv(file.path(folder, "fishnet_pa.csv"))
treat <- treat %>%
  group_by(fishnetid) %>%
  summarise(
    overlap_ratio = sum(overlap_area, na.rm = TRUE) / sum(fishnet_area, na.rm = TRUE),
    treatment = if_else(overlap_ratio > 0.5, 1, 2),
    .groups = "drop"
  ) 
table(treat$treatment)

treat_link <- treat %>% dplyr::select(fishnetid, treatment)

buffer_id <- read_csv(file.path(folder, "adjacent.csv"))

buffer_only <- buffer_id %>%
  distinct(fishnetid) %>%
  filter(!(fishnetid %in% treat$fishnetid))%>%
  mutate(treatment = 2)%>%
  dplyr::select(fishnetid, treatment)

treat_all <- bind_rows(treat_link, buffer_only)

dup_ids <- treat_all %>%
  group_by(fishnetid) %>%
  filter(n() > 1)


match1 <- match_up %>%
  left_join(treat_all, by = "fishnetid") %>%
  mutate(treatment = replace_na(treatment, 0))

match_bi <- match1 %>% filter(treatment != 2)

#install.packages('MatchIt')
library(MatchIt)

match_model <- matchit(
  treatment ~ elevation + slope + hf + road_den + access + intial_pop_density + build_den + ndvi,
  data = match_bi,
  method = "nearest",
  distance = "glm",
  replace = FALSE,
  caliper = 0.25,
  exact = ~ iso3 + landuse
)

matched_50 <- match.data(match_model)


plot_model <- match_model
plot_model$data$iso3 <- as.numeric(as.factor(plot_model$data$iso3))
plot_model$data$landuse <- as.numeric(as.factor(plot_model$data$landuse))


plot(plot_model, type = "qq", interactive = FALSE)
